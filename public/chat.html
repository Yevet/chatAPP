<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSE Chat Room</title>
    <link rel="stylesheet" href="chat_styles.css">

</head>

<body>
    <div class="header">
        <h1>FSE Chat Room</h1>
        <button id="logoutBtn">Logout</button>
    </div>

    <div class="chat-container">
        <!-- 聊天消息显示区域 -->
        <div id="messageArea">
        </div>

        <!-- 发送消息表单 -->
        <form id="messageForm">
            <div class="full-width">
                <input type="text" id="messageInput" placeholder="Enter your message">
            </div>
        </form>
    </div>

    <div class="footer">
        <button id="postBtn">Post</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 获取页面元素
            const messageArea = document.getElementById('messageArea');
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const postBtn = document.getElementById('postBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const loggedInUser = JSON.parse(decodeURIComponent(getCookie('loggedInUser')));


            // 从数据库中读取历史消息并显示在页面上
            // 假设您有一个/messages的API端点来获取历史消息
            fetch('/messages')
            .then(response => response.json())
            .then(data => {
                const messages = [];

                data.forEach(message => {
                    getUserUsername(message.user_id)
                        .then(username => {
                            const formattedTimestamp = new Date(message.timestamp).toLocaleString();
                            const displayUsername = message.user_id === loggedInUserId ? "Me" : username; // 判断是否是当前用户的消息
                            const messageElement = createMessageElement(displayUsername, formattedTimestamp, message.message);
                            messages.push({ timestamp: new Date(message.timestamp), element: messageElement });

                            if (messages.length === data.length) {
                                // 所有消息都已添加，现在进行排序
                                messages.sort((a, b) => a.timestamp - b.timestamp);

                                // 将排序后的消息添加到 messageArea
                                messages.forEach(msg => {
                                    messageArea.appendChild(msg.element);
                                });

                                // 滚动到底部
                                messageArea.scrollTop = messageArea.scrollHeight;
                            }
                        });
                });
            });




            function getUserUsername(userId) {
                return fetch(`/getUser/${userId}`)
                    .then(response => response.json())
                    .then(data => data.username);
            }

            // 创建消息元素的函数
            function createMessageElement(userId, timestamp, content) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');

                const messageHeader = document.createElement('div');
                messageHeader.classList.add('message-header');
                const senderSpan = document.createElement('span');
                senderSpan.classList.add('message-sender');
                senderSpan.textContent = `${userId}`;
                const timeSpan = document.createElement('span');
                timeSpan.classList.add('message-time');
                timeSpan.textContent = timestamp;

                messageHeader.appendChild(senderSpan);
                messageHeader.appendChild(timeSpan);

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('message-content');
                contentDiv.textContent = content;

                messageDiv.appendChild(messageHeader);
                messageDiv.appendChild(contentDiv);

                return messageDiv;
            }
            const socket = new WebSocket(`ws://${window.location.host}`);

            const loggedInUserId = loggedInUser.id;
            socket.addEventListener('message', (event) => {
                // 当收到新消息时，创建消息元素并将其添加到页面
                const message = JSON.parse(event.data);
                getUserUsername(message.user_id)
                    .then(username => {
                        const formattedTimestamp = new Date(message.timestamp).toLocaleString();
                        const displayUsername = message.user_id === loggedInUserId ? "Me" : username; // 判断是否是当前用户的消息
                        const messageElement = createMessageElement(displayUsername, formattedTimestamp, message.message);
                        messageArea.appendChild(messageElement);
                        messageArea.scrollTop = messageArea.scrollHeight;
                    });
            });

            // 添加 "Post" 按钮的点击事件处理
            postBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const message = messageInput.value.trim();

                if (message === '') {
                    return;
                }

                // 发送消息到服务器
                fetch('/postMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cookie': document.cookie
                    },
                    body: JSON.stringify({ message, user_id: loggedInUser.id })
                })
                    .then(response => response.json())
                    .then(data => {
                        messageInput.value = ''; // 清空输入框
                        messageArea.scrollTop = messageArea.scrollHeight;
                    });

            });

            // 添加 "Logout" 按钮的点击事件处理
            logoutBtn.addEventListener('click', function () {
                // 在这里实现登出逻辑
                // 例如：跳转到登录页面
                window.location.href = '/'; // 假设登录页面的路径为 "/"
            });
        });
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

    </script>

</body>

</html>